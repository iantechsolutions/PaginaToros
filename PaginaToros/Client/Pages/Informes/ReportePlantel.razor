@page "/reporteplantel"
@using PaginaToros.Client.Servicios.Contrato;
@inject IJSRuntime js
@inject IPlantelServicio _plantelServicio
@inject HttpClient http

<center><RadzenText TextStyle="TextStyle.H4">Informe de planteles</RadzenText></center>

<div>
    <DataAnnotationsValidator />
    <div class="row">
        <div class="col-sm">
            <label>Seleccionar Fecha Inicial</label>
            <RadzenDatePicker TValue="DateTime?" @bind-Value="@fechaInicial"
                              ShowTime="false" ShowSeconds="false" DateFormat="dd/MM/yyyy" Class="w-75"
                              @onchange="OnFechaInicialChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
        <div class="col-sm">
            <label>Seleccionar Fecha Final</label>
            <RadzenDatePicker TValue="DateTime?" @bind-Value="@fechaFinal"
                              ShowTime="false" ShowSeconds="false" DateFormat="dd/MM/yyyy" Class="w-75"
                              @onchange="OnFechaFinalChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
        <div class="col-sm">
            <label>Seleccione el estado de los planteles</label>
            <RadzenDropDown @bind-Value="@seleccion" Data="@opciones" Style="width: 100%; max-width: 400px;"
                            Change="OnSeleccionChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
    </div>
</div>

<br />

@* *** Toolbar SIEMPRE visible, con Generar siempre accesible *@
<div style="display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
    <button class="font-bold px-6 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-2"
            style="width: 150px;" @onclick="Generate" disabled="@(!CanGenerate)">
        @if (isLoading)
        {
            <span><i class="fa fa-spinner fa-spin"></i> Generando...</span>
        }
        else
        {
            <span>Generar</span>
        }
    </button>

    <button class="no-print font-bold px-6 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-2"
            style="width: 150px;" @onclick="DescargarExcel" disabled="@(isLoading || !terminado || !plantelesConAnio.Any() && !plantelesSinAnio.Any())">
        Descargar Excel
    </button>

    <button class="no-print px-4 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center"
            style="width: 100px;" @onclick="Print" disabled="@(isLoading || !terminado)">
        <FeatherPrinter Color="Black"></FeatherPrinter>
    </button>

    <button @onclick="ReiniciarFiltros"
            class="font-bold px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-300 transition ease-in duration-100"
            style="width: 150px;" disabled="@isLoading">
        Reiniciar Filtros
    </button>
</div>

@if (terminado)
{
    <table style="border-collapse:collapse;position:relative;left:3%;width:95%" cellspacing="0">
        <tr>
            <td colspan="9">
                <p class="2"> TOTAL GENERAL</p>
            </td>
        </tr>
        <tr>
            <td><p class="s2">Plantel</p></td>
            <td colspan="3" style="text-align:center"><p class="s2">PR</p></td>
            <td colspan="3" style="text-align:center"><p class="s2">VIP</p></td>
            <td><p class="s2">Socio</p></td>
            <td><p class="s2">Estado</p></td>
        </tr>
        <tr>
            <td></td>
            <td><p class="s2">Vacas</p></td>
            <td><p class="s2">Vaquill. c/servicio</p></td>
            <td><p class="s2">Vaquill. s/servicio</p></td>
            <td><p class="s2">Vacas</p></td>
            <td><p class="s2">Vaquill. c/servicio</p></td>
            <td><p class="s2">Vaquill. s/servicio</p></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Varede ?? 0)</p></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Vqcsrd ?? 0)</p></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Vqssrd ?? 0)</p></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Varepr ?? 0)</p></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Vqcsrp ?? 0)</p></td>
            <td><p class="s2">@plantelesConAnio.Sum(x => x.Vqssrp ?? 0)</p></td>
            <td></td>
            <td></td>
        </tr>
    </table>
    <br />
    <br />

    @foreach (int i in anios)
    {
        var datosAnio = plantelesConAnio
            .Where(x => int.TryParse(x.Anioex, out var yy) && yy == i)
            .ToList();

        <RadzenText TextStyle="Radzen.Blazor.TextStyle.H4">Año @i</RadzenText>

        <table style="border-collapse:collapse;position:relative;left:3%;width:95%" cellspacing="0">
            <tr>
                <td><p class="s2">Plantel</p></td>
                <td><p class="s2">Vacas PR</p></td>
                <td><p class="s2">Vaq. PR C/S</p></td>
                <td><p class="s2">Vaq. PR S/S</p></td>
                <td><p class="s2">Vacas</p></td>
                <td><p class="s2">Vaq. VIP C/S o preñadas</p></td>
                <td><p class="s2">Vaq. VIP S/S</p></td>
                <td><p class="s2">Socio</p></td>
                <td><p class="s2">Estado</p></td>
            </tr>

            @if (datosAnio.Any())
            {
                @foreach (var plan in datosAnio)
                {
                    <tr>
                        <td><p class="s2">@plan.Placod</p></td>
                        <td><p class="s2">@plan.Varede</p></td>
                        <td><p class="s2">@plan.Vqcsrd</p></td>
                        <td><p class="s2">@plan.Vqssrd</p></td>
                        <td><p class="s2">@plan.Varepr</p></td>
                        <td><p class="s2">@plan.Vqcsrp</p></td>
                        <td><p class="s2">@plan.Vqssrp</p></td>
                        <td><p class="s2">@plan.Socio?.Nombre</p></td>
                        <td>
                            @if (!string.IsNullOrEmpty(plan.Estado) && plan.Estado == "S")
                            {
                                <p class="s2" style="color:green">Activo</p>
                            }
                            else
                            {
                                <p class="s2" style="color:red">Inactivo</p>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9"><p class="s2">No hay datos para este año.</p></td>
                </tr>
            }

            <tr>
                <td colspan="9"><p class="s2">TOTAL del año @i</p></td>
            </tr>
            <tr>
                <td></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Varede ?? 0)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqcsrd ?? 0)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqssrd ?? 0)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Varepr ?? 0)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqcsrp ?? 0)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqssrp ?? 0)</p></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    }

    @* Separate section for planteles without Anioex *@
    @if (plantelesSinAnio.Any())
    {
        <br />
        <RadzenText TextStyle="Radzen.Blazor.TextStyle.H4">Planteles sin año</RadzenText>
        <table style="border-collapse:collapse;position:relative;left:3%;width:95%" cellspacing="0">
            <tr>
                <td><p class="s2">Plantel</p></td>
                <td><p class="s2">Vacas PR</p></td>
                <td><p class="s2">Vaq. PR C/S</p></td>
                <td><p class="s2">Vaq. PR S/S</p></td>
                <td><p class="s2">Vacas VIP</p></td>
                <td><p class="s2">Vaq. VIP C/S</p></td>
                <td><p class="s2">Vaq. VIP S/S</p></td>
                <td><p class="s2">Socio</p></td>
                <td><p class="s2">Estado</p></td>
            </tr>

            @foreach (var plan in plantelesSinAnio)
            {
                <tr>
                    <td><p class="s2">@plan.Placod</p></td>
                    <td><p class="s2">@plan.Varede</p></td>
                    <td><p class="s2">@plan.Vqcsrd</p></td>
                    <td><p class="s2">@plan.Vqssrd</p></td>
                    <td><p class="s2">@plan.Varepr</p></td>
                    <td><p class="s2">@plan.Vqcsrp</p></td>
                    <td><p class="s2">@plan.Vqssrp</p></td>
                    <td><p class="s2">@plan.Socio?.Nombre</p></td>
                    <td>
                        @if (!string.IsNullOrEmpty(plan.Estado) && plan.Estado == "S")
                        {
                            <p class="s2" style="color:green">Activo</p>
                        }
                        else
                        {
                            <p class="s2" style="color:red">Inactivo</p>
                        }
                    </td>
                </tr>
            }

            <tr>
                <td colspan="9"><p class="s2">TOTAL (Sin año)</p></td>
            </tr>
            <tr>
                <td></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Varede ?? 0)</p></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Vqcsrd ?? 0)</p></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Vqssrd ?? 0)</p></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Varepr ?? 0)</p></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Vqcsrp ?? 0)</p></td>
                <td><p class="s2">@plantelesSinAnio.Sum(x => x.Vqssrp ?? 0)</p></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    }
}

@code {
    public DateTime? fechaInicial { get; set; } = new DateTime(2020, 1, 1);
    public DateTime? fechaFinal { get; set; } = DateTime.Now;

    // Full fetched list (after applying 'seleccion')
    public List<PlantelDTO> plantelesAll = new();
    // Split lists
    public List<PlantelDTO> plantelesConAnio = new();
    public List<PlantelDTO> plantelesSinAnio = new();

    List<string> opciones = new() { "Activos", "Inactivos", "Todos" };
    List<int> anios = new();

    bool terminado = false;
    bool isLoading = false;
    string seleccion = "Activos";

    // Debounce
    private CancellationTokenSource? debounceCts;
    private readonly int debounceMs = 700;

    private bool CanGenerate => !isLoading && fechaInicial != null && fechaFinal != null && fechaInicial <= fechaFinal;

    private async Task Generate()
    {
        if (isLoading) return; // *** evita dobles clics

        // *** Validación de fechas
        if (fechaInicial == null || fechaFinal == null)
        {
            Console.WriteLine("Fechas inválidas");
            return;
        }
        if (fechaInicial > fechaFinal)
        {
            Console.WriteLine("La fecha inicial no puede ser mayor que la final.");
            return;
        }

        isLoading = true;
        terminado = false;
        plantelesAll.Clear();
        plantelesConAnio.Clear();
        plantelesSinAnio.Clear();
        anios.Clear();
        StateHasChanged();

        try
        {
            var rtaa = await _plantelServicio.ObtenerPorRangoFechas(fechaInicial.Value, fechaFinal.Value);
            var lista = rtaa?.List ?? new List<PlantelDTO>();

            // Apply state selection filter
            plantelesAll = seleccion switch
            {
                "Activos" => lista.Where(x => x.Estado == "S").ToList(),
                "Inactivos" => lista.Where(x => x.Estado == "N").ToList(),
                _ => lista
            };

            // Split by Anioex
            plantelesConAnio = plantelesAll
                .Where(x => !string.IsNullOrEmpty(x.Anioex) && int.TryParse(x.Anioex, out _))
                .ToList();

            plantelesSinAnio = plantelesAll
                .Where(x => string.IsNullOrEmpty(x.Anioex) || !int.TryParse(x.Anioex, out _))
                .ToList();

            anios = plantelesConAnio
                .Select(x => int.Parse(x.Anioex!))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            terminado = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DescargarExcel()
    {
        // Request server to generate and return the Excel
        if (!plantelesConAnio.Any() && !plantelesSinAnio.Any()) return;

        try
        {
            var desde = fechaInicial?.ToString("yyyy-MM-dd");
            var hasta = fechaFinal?.ToString("yyyy-MM-dd");
            var url = $"api/plantel/ExportarExcel?desde={desde}&hasta={hasta}&seleccion={Uri.EscapeDataString(seleccion ?? "Todos")}";

            var bytes = await http.GetByteArrayAsync(url);
            var fileName = $"reporte-planteles_{DateTime.Now:yyyyMMdd}.xlsx";
            var contentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            var dataUrl = $"data:{contentType};base64,{Convert.ToBase64String(bytes)}";

            await js.InvokeVoidAsync("saveAsFile", fileName, dataUrl);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error descargando Excel: {ex.Message}");
        }
    }

    private void ReiniciarFiltros()
    {
        fechaInicial = new DateTime(2020, 1, 1); // *** restauro default
        fechaFinal = DateTime.Now;               // *** restauro default
        seleccion = "Activos";

        plantelesAll.Clear();
        plantelesConAnio.Clear();
        plantelesSinAnio.Clear();
        anios.Clear();
        terminado = false;

        StateHasChanged();
        // Opcional: llamar a Generate() automáticamente:
        // _ = Generate();
    }

    private async Task Print()
        => await js.InvokeVoidAsync("window.print");

    // Debounced auto-regenerate
    private async Task DebouncedGenerate()
    {
        debounceCts?.Cancel();
        debounceCts = new CancellationTokenSource();
        var token = debounceCts.Token;

        try
        {
            await Task.Delay(debounceMs, token);
            await Generate();
        }
        catch (TaskCanceledException)
        {
            // ignored
        }
    }

    private async Task OnFechaInicialChanged(ChangeEventArgs e)
    {
        await DebouncedGenerate(); // regenerate after debounce
    }

    private async Task OnFechaFinalChanged(ChangeEventArgs e)
    {
        await DebouncedGenerate();
    }

    private async Task OnSeleccionChanged(object args)
    {
        await DebouncedGenerate();
    }
}

@page "/reporteplantel"
@using PaginaToros.Client.Servicios.Contrato;
@inject IJSRuntime js
@inject IPlantelServicio _plantelServicio

@using OfficeOpenXml
@using OfficeOpenXml.Style
@using System.Drawing

<center><RadzenText TextStyle="TextStyle.H4">Informe de planteles</RadzenText></center>

<div>
    <DataAnnotationsValidator />
    <div class="row">
        <div class="col-sm">
            <label>Seleccionar Fecha Inicial</label>
            <RadzenDatePicker TValue="DateTime?" @bind-Value="@fechaInicial"
                              ShowTime="false" ShowSeconds="false" DateFormat="dd/MM/yyyy" Class="w-75"
                              @onchange="OnFechaInicialChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
        <div class="col-sm">
            <label>Seleccionar Fecha Final</label>
            <RadzenDatePicker TValue="DateTime?" @bind-Value="@fechaFinal"
                              ShowTime="false" ShowSeconds="false" DateFormat="dd/MM/yyyy" Class="w-75"
                              @onchange="OnFechaFinalChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
        <div class="col-sm">
            <label>Seleccione el estado de los planteles</label>
            <RadzenDropDown @bind-Value="@seleccion" Data="@opciones" Style="width: 100%; max-width: 400px;"
                            Change="OnSeleccionChanged" /> @* *** auto-regenerar (opcional) *@
        </div>
    </div>
</div>

<br />

@* *** Toolbar SIEMPRE visible, con Generar siempre accesible *@
<div style="display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
    <button class="font-bold px-6 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-2"
            style="width: 150px;" @onclick="Generate" disabled="@isLoading">
        @if (isLoading)
        {
            <span><i class="fa fa-spinner fa-spin"></i> Generando...</span>
        }
        else
        {
            <span>Generar</span>
        }
    </button>

    <button class="no-print font-bold px-6 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-2"
            style="width: 150px;" @onclick="DescargarExcel" disabled="@(isLoading || !terminado || !planteles.Any())">
        Descargar Excel
    </button>

    <button class="no-print px-4 py-2 rounded-2xl bg-gray-200 hover:bg-gray-300 transition ease-in duration-100 transform hover:-translate-y-1 active:translate-y-0 flex items-center justify-center"
            style="width: 100px;" @onclick="Print" disabled="@(isLoading || !terminado)">
        <FeatherPrinter Color="Black"></FeatherPrinter>
    </button>

    <button @onclick="ReiniciarFiltros"
            class="font-bold px-4 py-2 rounded-2xl bg-gray-100 hover:bg-gray-300 transition ease-in duration-100"
            style="width: 150px;" disabled="@isLoading">
        Reiniciar Filtros
    </button>
</div>

@if (terminado)
{
    <table style="border-collapse:collapse;position:relative;left:3%;width:95%" cellspacing="0">
        <tr>
            <td colspan="9">
                <p class="2"> TOTAL GENERAL</p>
            </td>
        </tr>
        <tr>
            <td><p class="s2">Plantel</p></td>
            <td colspan="3" style="text-align:center"><p class="s2">PR</p></td>
            <td colspan="3" style="text-align:center"><p class="s2">VIP</p></td>
            <td><p class="s2">Socio</p></td>
            <td><p class="s2">Estado</p></td>
        </tr>
        <tr>
            <td></td>
            <td><p class="s2">Vacas</p></td>
            <td><p class="s2">Vaquill. c/servicio</p></td>
            <td><p class="s2">Vaquill. s/servicio</p></td>
            <td><p class="s2">Vacas</p></td>
            <td><p class="s2">Vaquill. c/servicio</p></td>
            <td><p class="s2">Vaquill. s/servicio</p></td>
            <td></td>
            <td></td>
        </tr>
        <tr> <td></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Varede)</p></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Vqcsrd)</p></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Vqssrd)</p></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Varepr)</p></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Vqcsrp)</p></td> <td><p class="s2">@planteles.Where(x => !string.IsNullOrEmpty(x.Anioex)).Sum(x => x.Vqssrp)</p></td> <td></td> <td></td> </tr>
    </table>
    <br />
    <br />

    @foreach (int i in anios)
    {
        var datosAnio = planteles
            .Where(x => !string.IsNullOrEmpty(x.Anioex) && int.TryParse(x.Anioex, out var yy) && yy == i)
            .ToList();

        <RadzenText TextStyle="Radzen.Blazor.TextStyle.H4">Año @i</RadzenText>

        <table style="border-collapse:collapse;position:relative;left:3%;width:95%" cellspacing="0">
            <tr>
                <td><p class="s2">Plantel</p></td>
                <td><p class="s2">Vacas PR</p></td>
                <td><p class="s2">Vaq. PR C/S</p></td>
                <td><p class="s2">Vaq. PR S/S</p></td>
                <td><p class="s2">Vacas</p></td>
                <td><p class="s2">Vaq. VIP C/S o preñadas</p></td>
                <td><p class="s2">Vaq. VIP S/S</p></td>
                <td><p class="s2">Socio</p></td>
                <td><p class="s2">Estado</p></td>
            </tr>

            @if (datosAnio.Any())
            {
                @foreach (var plan in datosAnio)
                {
                    <tr>
                        <td><p class="s2">@plan.Placod</p></td>
                        <td><p class="s2">@plan.Varede</p></td>
                        <td><p class="s2">@plan.Vqcsrd</p></td>
                        <td><p class="s2">@plan.Vqssrd</p></td>
                        <td><p class="s2">@plan.Varepr</p></td>
                        <td><p class="s2">@plan.Vqcsrp</p></td>
                        <td><p class="s2">@plan.Vqssrp</p></td>
                        <td><p class="s2">@plan.Socio?.Nombre</p></td>
                        <td>
                            @if (!string.IsNullOrEmpty(plan.Estado) && plan.Estado == "S")
                            {
                                <p class="s2" style="color:green">Activo</p>
                            }
                            else
                            {
                                <p class="s2" style="color:red">Inactivo</p>
                            }
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="9"><p class="s2">No hay datos para este año.</p></td>
                </tr>
            }

            <tr>
                <td colspan="9"><p class="s2">TOTAL del año @i</p></td>
            </tr>
            <tr>
                <td></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Varede)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqcsrd)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqssrd)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Varepr)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqcsrp)</p></td>
                <td><p class="s2">@datosAnio.Sum(x => x.Vqssrp)</p></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    }
}

@code {
    public DateTime? fechaInicial { get; set; } = new DateTime(2020, 1, 1);
    public DateTime? fechaFinal { get; set; } = DateTime.Now;

    public List<PlantelDTO> planteles = new();
    List<string> opciones = new() { "Activos", "Inactivos", "Todos" };
    List<int> anios = new();

    bool terminado = false;
    bool isLoading = false;
    string seleccion = "Activos";

    private async Task Generate()
    {
        if (isLoading) return; // *** evita dobles clics

        // *** Validación de fechas
        if (fechaInicial == null || fechaFinal == null)
        {
            Console.WriteLine("Fechas inválidas");
            return;
        }
        if (fechaInicial > fechaFinal)
        {
            Console.WriteLine("La fecha inicial no puede ser mayor que la final.");
            return;
        }

        isLoading = true;
        terminado = false;
        planteles.Clear();
        anios.Clear();
        StateHasChanged();

        try
        {
            var rtaa = await _plantelServicio.ObtenerPorRangoFechas(fechaInicial.Value, fechaFinal.Value);
            var lista = rtaa?.List ?? new List<PlantelDTO>();

            planteles = seleccion switch
            {
                "Activos" => lista.Where(x => x.Estado == "S").ToList(),
                "Inactivos" => lista.Where(x => x.Estado == "N").ToList(),
                _ => lista
            };

            anios = planteles
                .Where(x => !string.IsNullOrEmpty(x.Anioex) && int.TryParse(x.Anioex, out _))
                .Select(x => int.Parse(x.Anioex))
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            terminado = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DescargarExcel()
    {
        if (!planteles.Any()) return;

        using var package = new ExcelPackage();

        // --------- Hoja 1: Resumen general ----------
        var resumen = package.Workbook.Worksheets.Add("Resumen General");

        resumen.Cells[1, 1].Value = "Plantel";
        resumen.Cells[1, 2].Value = "Vacas PR";
        resumen.Cells[1, 3].Value = "Vaq. PR c/servicio";
        resumen.Cells[1, 4].Value = "Vaq. PR s/servicio ";
        resumen.Cells[1, 5].Value = "Vacas VIP";
        resumen.Cells[1, 6].Value = "Vaq. VIP c/servicio";
        resumen.Cells[1, 7].Value = "Vaq. VIP s/servicio";
        resumen.Cells[1, 8].Value = "Socio";
        resumen.Cells[1, 9].Value = "Estado";
        resumen.Cells[1, 10].Value = "Año";

        resumen.Cells[2, 1].Value = "TOTAL GENERAL";
        resumen.Cells[2, 2].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Varede);
        resumen.Cells[2, 3].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Vqcsrd);
        resumen.Cells[2, 4].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Vqssrd);
        resumen.Cells[2, 5].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Varepr);
        resumen.Cells[2, 6].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Vqcsrp);
        resumen.Cells[2, 7].Value = planteles.Where(p => !string.IsNullOrEmpty(p.Anioex)).Sum(p => p.Vqssrp);
        resumen.Cells[2, 8].Value = "";
        resumen.Cells[2, 9].Value = "";
        resumen.Cells[2, 10].Value = "";

        resumen.Cells[1, 1, 2, 10].AutoFitColumns();

        // --------- Hojas por Año ----------
        var years = anios; // *** uso la lista ya calculada, evito sombreado

        foreach (var año in years)
        {
            var hoja = package.Workbook.Worksheets.Add($"Año {año}");

            hoja.Cells[1, 1].Value = "Plantel";
            hoja.Cells[1, 2].Value = "Vacas PR";
            hoja.Cells[1, 3].Value = "Vaq.PR c/servicio ";
            hoja.Cells[1, 4].Value = "Vaq. PR s/servicio";
            hoja.Cells[1, 5].Value = "Vacas VIP";
            hoja.Cells[1, 6].Value = "Vaq. VIP c/servicio";
            hoja.Cells[1, 7].Value = "Vaq. VIP s/servicio";
            hoja.Cells[1, 8].Value = "Socio";
            hoja.Cells[1, 9].Value = "Estado";

            var datosAnio = planteles
                .Where(p => !string.IsNullOrEmpty(p.Anioex) && int.TryParse(p.Anioex, out var yy) && yy == año)
                .ToList();

            int r = 2;
            foreach (var p in datosAnio)
            {
                hoja.Cells[r, 1].Value = p.Placod;
                hoja.Cells[r, 2].Value = p.Varede;
                hoja.Cells[r, 3].Value = p.Vqcsrd;
                hoja.Cells[r, 4].Value = p.Vqssrd;
                hoja.Cells[r, 5].Value = p.Varepr;
                hoja.Cells[r, 6].Value = p.Vqcsrp;
                hoja.Cells[r, 7].Value = p.Vqssrp;
                hoja.Cells[r, 8].Value = p.Socio?.Nombre;
                hoja.Cells[r, 9].Value = p.Estado == "S" ? "Activo" : "Inactivo";
                r++;
            }

            hoja.Cells[r, 1].Value = $"TOTAL del año {año}";
            hoja.Cells[r, 2].Value = datosAnio.Sum(x => x.Varede);
            hoja.Cells[r, 3].Value = datosAnio.Sum(x => x.Vqcsrd);
            hoja.Cells[r, 4].Value = datosAnio.Sum(x => x.Vqssrd);
            hoja.Cells[r, 5].Value = datosAnio.Sum(x => x.Varepr);
            hoja.Cells[r, 6].Value = datosAnio.Sum(x => x.Vqcsrp);
            hoja.Cells[r, 7].Value = datosAnio.Sum(x => x.Vqssrp);

            hoja.Cells[1, 1, r, 9].AutoFitColumns();
        }

        var bytes = package.GetAsByteArray();
        var fileName = "reporte-planteles.xlsx";
        var contentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
        var url = $"data:{contentType};base64,{Convert.ToBase64String(bytes)}";

        await js.InvokeVoidAsync("saveAsFile", fileName, url);
    }

    private void ReiniciarFiltros()
    {
        fechaInicial = new DateTime(2020, 1, 1); // *** restauro default
        fechaFinal = DateTime.Now;               // *** restauro default
        seleccion = "Activos";

        planteles.Clear();
        anios.Clear();
        terminado = false;

        StateHasChanged();
        // Opcional: llamar a Generate() automáticamente:
        // _ = Generate();
    }

    private async Task Print()
        => await js.InvokeVoidAsync("window.print");

    // ----- Auto-regenerar al cambiar filtros (opcional: ya está activo)
    private async Task OnFechaInicialChanged(ChangeEventArgs _)
    {
        // _ = Generate(); // si preferís regenerar en vivo, descomentar
    }

    private async Task OnFechaFinalChanged(ChangeEventArgs _)
    {
        // _ = Generate(); // si preferís regenerar en vivo, descomentar
    }

    private async Task OnSeleccionChanged(object _)
    {
        // _ = Generate(); // si preferís regenerar en vivo, descomentar
    }
}
